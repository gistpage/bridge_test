<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <title>WSD Bridge H5 测试</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      background: #f4f6fa;
    }

    .banner {
      background: linear-gradient(90deg, #6a11cb 0%, #2575fc 100%);
      color: #fff;
      padding: 32px 20px 20px 20px;
      text-align: center;
      border-bottom-left-radius: 32px;
      border-bottom-right-radius: 32px;
      box-shadow: 0 2px 8px rgba(106, 17, 203, 0.08);
    }

    .banner h1 {
      margin: 0 0 8px 0;
      font-size: 2.2em;
      letter-spacing: 2px;
    }

    .banner p {
      margin: 0;
      font-size: 1.1em;
      opacity: 0.92;
    }

    .env-status {
      margin: 18px auto 0 auto;
      max-width: 520px;
      padding: 10px 0;
      font-size: 1.1em;
      font-weight: bold;
      border-radius: 8px;
      text-align: center;
    }

    .env-ok {
      background: #e6ffed;
      color: #237804;
      border: 1px solid #b7eb8f;
    }

    .env-fail {
      background: #fff1f0;
      color: #cf1322;
      border: 1px solid #ffa39e;
    }

    .section {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      padding: 22px 18px 18px 18px;
      margin: 28px auto 0 auto;
      max-width: 520px;
      border-left: 6px solid #6a11cb;
      position: relative;
    }

    .section h2 {
      color: #2575fc;
      margin-top: 0;
      font-size: 1.25em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section .icon {
      font-size: 1.3em;
      margin-right: 4px;
    }

    label {
      display: block;
      margin-top: 8px;
      font-weight: 500;
    }

    input,
    textarea {
      width: 100%;
      margin-top: 4px;
      margin-bottom: 8px;
      border-radius: 6px;
      border: 1px solid #d0d7e2;
      padding: 7px 10px;
      font-size: 1em;
      background: #f8fafd;
    }

    button {
      margin-top: 8px;
      padding: 10px 0;
      width: 100%;
      border: none;
      border-radius: 6px;
      font-size: 1.1em;
      font-weight: bold;
      background: linear-gradient(90deg, #6a11cb 0%, #2575fc 100%);
      color: #fff;
      cursor: pointer;
      box-shadow: 0 1px 4px rgba(106, 17, 203, 0.08);
      transition: background 0.2s;
    }

    button:hover {
      background: linear-gradient(90deg, #2575fc 0%, #6a11cb 100%);
    }

    .result-box {
      background: #f0f7ff;
      color: #1a237e;
      border-radius: 6px;
      border: 1px solid #b3c6e6;
      margin-top: 8px;
      padding: 8px 10px;
      font-size: 15px;
      min-height: 22px;
      font-family: 'Fira Mono', 'Consolas', 'Menlo', monospace;
      word-break: break-all;
    }

    .tip {
      background: #fffbe6;
      color: #b8860b;
      border-left: 5px solid #ffe066;
      padding: 10px 14px;
      border-radius: 8px;
      margin: 18px auto 0 auto;
      max-width: 520px;
      font-size: 1em;
      font-weight: 500;
    }

    @media (max-width: 600px) {

      .section,
      .tip,
      .env-status {
        max-width: 98vw;
      }

      .banner {
        padding: 24px 4vw 14px 4vw;
      }
    }

    .accordion {
      border: 1px solid #b3c6e6;
      border-radius: 8px;
      margin-bottom: 14px;
      background: #f8fafd;
    }

    .accordion-header {
      cursor: pointer;
      padding: 10px 12px;
      font-weight: bold;
      color: #2575fc;
      display: flex;
      align-items: center;
      justify-content: space-between;
      user-select: none;
    }

    .accordion-arrow {
      font-size: 1.1em;
      transition: transform 0.2s;
    }

    .accordion-arrow.open {
      transform: rotate(90deg);
    }

    .accordion-content {
      display: none;
      padding: 0 12px 12px 12px;
    }

    .accordion.open .accordion-content {
      display: block;
    }

    .accordion-main {
      border: 2px solid #b3c6e6;
      border-radius: 14px;
      margin: 28px auto 0 auto;
      background: #fff;
      max-width: 520px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      border-left: 6px solid #6a11cb;
      position: relative;
    }

    .accordion-main-header {
      cursor: pointer;
      padding: 18px 18px 18px 24px;
      font-size: 1.25em;
      font-weight: bold;
      color: #2575fc;
      display: flex;
      align-items: center;
      justify-content: space-between;
      user-select: none;
      border-radius: 14px 14px 0 0;
      background: #f4f6fa;
    }

    .accordion-main-arrow {
      font-size: 1.2em;
      transition: transform 0.2s;
    }

    .accordion-main-arrow.open {
      transform: rotate(90deg);
    }

    .accordion-main-content {
      display: none;
      padding: 0 18px 18px 18px;
    }

    .accordion-main.open .accordion-main-content {
      display: block;
    }
  </style>
</head>

<body>
  <div class="banner">
    <h1>🧪 WSD Bridge H5 </h1>
    <p>一站式验证 <b>JSBridge</b> 与原生桥接能力，支持 eventTracker、openWebView、参数校验、回调等全流程。<br>请在 App WebView 中访问本页，所有结果实时高亮展示。</p>
  </div>

  <div id="pageTimestamp" class="env-status"
    style="background:#fffbe6;color:#b8860b;border:1px solid #ffe066;margin-top:8px;">页面加载时间戳：<span
      id="timestampValue"></span></div>

  <div id="envStatus" class="env-status">环境检测中...</div>

  <div class="section">
    <h2><span class="icon">📊</span>1. eventTracker 测试</h2>
    <label>eventName:</label>
    <input id="eventTrackerName" value="test_event" />
    <label>eventValue (JSON):</label>
    <textarea id="eventTrackerValue">{"foo": "bar"}</textarea>
    <button onclick="callEventTracker()">🚀 调用 eventTracker</button>
    <div id="result-eventTracker" class="result-box"></div>
    <button onclick="copyResult('result-eventTracker')"
      style="margin-top:4px;background:#e6f7ff;color:#1890ff;">复制结果</button>

    <hr style="margin:24px 0;">
    <div style="font-size:1em;color:#2575fc;margin-bottom:8px;">【官方事件参数可编辑测试】</div>
    <div id="eventTrackerOfficialTests"></div>

    <!-- 添加增强版 EventTracker 测试区域 -->
    <hr style="margin:24px 0;">
    <div style="font-size:1em;color:#ff6b35;margin-bottom:8px;">【🚀 增强版 EventTracker 测试】</div>
    <div style="background:#fff0e6;border:1px solid #ff6b35;border-radius:6px;padding:12px;margin-bottom:12px;">
      <strong>📋 增强版说明：</strong>
      <ul style="margin:8px 0;padding-left:20px;font-size:0.95em;">
        <li><strong>调用方式：直接调用原生 EventTracker 服务</strong></li>
        <li>完整的服务器回调信息（成功/失败详情）</li>
        <li>详细的设备信息和环境检测</li>
        <li>实时显示 Adjust SDK 响应状态</li>
        <li><strong style="color:#ff6b35;">⚡ 这是之前原生橙色bug按钮的功能！</strong></li>
        <li>对比默认JSBridge：可看到完整处理流程和回调</li>
      </ul>
    </div>
    <div style="background:#e6ffed;border:1px solid #52c41a;border-radius:6px;padding:12px;margin-bottom:12px;">
      <strong style="color:#237804;">🔍 与默认eventTracker区别：</strong>
      <ol style="margin:8px 0;padding-left:20px;font-size:0.95em;color:#237804;">
        <li><strong>默认版本</strong>：简单的桥接调用，日志较少</li>
        <li><strong>增强版本</strong>：完整的回调监听，详细的调试信息</li>
        <li>增强版会显示：服务器响应、ADID、环境状态、错误详情</li>
        <li>适合调试和验证Adjust事件是否真正成功上报</li>
        <li>原生Home页面的橙色bug按钮功能现在在这里</li>
      </ol>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;">
      <button onclick="testEnhancedEventTracker('firstOpen')"
        style="background:#ff6b35;color:#fff;flex:1;min-width:200px;">🚀 增强版 firstOpen</button>
      <button onclick="testEnhancedEventTracker('register')"
        style="background:#722ed1;color:#fff;flex:1;min-width:150px;">📝 增强版 register</button>
      <button onclick="testEnhancedEventTracker('deposit')"
        style="background:#52c41a;color:#fff;flex:1;min-width:150px;">💰 增强版 deposit</button>
    </div>
    <div id="result-enhanced-tracker" class="result-box"></div>
    <div style="display:flex;gap:8px;margin-top:4px;">
      <button onclick="copyResult('result-enhanced-tracker')"
        style="background:#e6f7ff;color:#1890ff;flex:1;">复制结果</button>
      <button onclick="clearEnhancedResult()" style="background:#f6f8fa;color:#666;flex:1;">清除结果</button>
      <button onclick="compareWithDefault()" style="background:#fa8c16;color:#fff;flex:1;">🔄 对比测试</button>
    </div>

    <!-- 添加专门的 firstOpen 沙盒测试区域 -->
    <hr style="margin:24px 0;">
    <div style="font-size:1em;color:#2575fc;margin-bottom:8px;">【🧪 沙盒环境 firstOpen 专项测试】</div>
    <div style="background:#fff8e6;border:1px solid #ffe066;border-radius:6px;padding:12px;margin-bottom:12px;">
      <strong>📋 沙盒测试说明：</strong>
      <ul style="margin:8px 0;padding-left:20px;font-size:0.95em;">
        <li><strong>当前环境：SANDBOX (沙盒)</strong></li>
        <li>App Token: y0mht8z9n1fk</li>
        <li>Event Token: q6mgkw (firstOpen 专用)</li>
        <li><strong style="color:#d46b08;">⚠️ 重要：沙盒数据不在主控制台显示</strong></li>
        <li><strong>正确查看位置：Adjust后台 → 【测试】→ 【设备日志】</strong></li>
        <li>成功标志：控制台显示 "🎉 [Adjust] 事件上报成功！"</li>
        <li>数据延迟：沙盒环境可能有 2-10 分钟延迟</li>
      </ul>
    </div>
    <div style="background:#e6ffed;border:1px solid #b7eb8f;border-radius:6px;padding:12px;margin-bottom:12px;">
      <strong style="color:#237804;">🔍 调试步骤：</strong>
      <ol style="margin:8px 0;padding-left:20px;font-size:0.95em;color:#237804;">
        <li>点击 "🚀 测试 firstOpen" 按钮</li>
        <li>检查页面显示 "✅ 桥接调用成功"</li>
        <li>等待控制台显示 Adjust 服务器回调</li>
        <li>如果 5 分钟内无回调，点击 "🔍 环境检查"</li>
        <li>最终在 Adjust 后台【测试】→【设备日志】查看数据</li>
      </ol>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;">
      <button onclick="testFirstOpenSandbox()" style="background:#52c41a;color:#fff;flex:1;min-width:200px;">🚀 测试
        firstOpen (沙盒专用)</button>
      <button onclick="checkNetworkAndAdjustStatus()" style="background:#1890ff;color:#fff;flex:1;min-width:150px;">🔍
        环境检查</button>
      <button onclick="startAdjustCallbackMonitoring()" style="background:#722ed1;color:#fff;flex:1;min-width:150px;">📡
        监听回调</button>
    </div>
    <div id="result-firstOpen-sandbox" class="result-box"></div>
    <div style="display:flex;gap:8px;margin-top:4px;">
      <button onclick="copyResult('result-firstOpen-sandbox')"
        style="background:#e6f7ff;color:#1890ff;flex:1;">复制结果</button>
      <button onclick="clearSandboxResult()" style="background:#f6f8fa;color:#666;flex:1;">清除结果</button>
      <button onclick="openAdjustDebugTool()" style="background:#fa8c16;color:#fff;flex:1;">🛠️ 调试工具</button>
    </div>
  </div>

  <div class="section">
    <h2><span class="icon">🌐</span>2. openWebView 测试</h2>
    <label>url:</label>
    <input id="openWebViewUrl" value="https://flutter.dev" />
    <label>type (1=外跳, 2=内嵌):</label>
    <input id="openWebViewType" value="2" />
    <button onclick="callOpenWebView(2, 'https://www.example.com')">测试内跳（type=2）</button>
    <button onclick="callOpenWebView(1, 'https://www.example.com')">测试外跳（type=1）</button>
    <div id="resultBox" style="margin-top:20px;"></div>
    <button onclick="copyResult('resultBox')" style="margin-top:4px;background:#e6f7ff;color:#1890ff;">复制结果</button>
  </div>

  <div class="section">
    <h2><span class="icon">🌍</span>3. openAndroid 测试</h2>
    <label>url:</label>
    <input id="openAndroidUrl" value="https://www.baidu.com" />
    <button onclick="callOpenAndroid()">🔗 调用 openAndroid</button>
    <div id="result-openAndroid" class="result-box"></div>
    <button onclick="copyResult('result-openAndroid')"
      style="margin-top:4px;background:#e6f7ff;color:#1890ff;">复制结果</button>
  </div>

  <div class="section">
    <h2><span class="icon">❌</span>4. closeWebView 测试</h2>
    <button onclick="callCloseWebView()">🛑 调用 closeWebView</button>
    <div id="result-closeWebView" class="result-box"></div>
    <button onclick="copyResult('result-closeWebView')"
      style="margin-top:4px;background:#e6f7ff;color:#1890ff;">复制结果</button>
    <div style="text-align:center;margin:16px 0;">
      <button onclick="openChildTestPage()" style="width:auto;padding:8px 24px;font-size:1em;">打开二级测试页（新标签页）</button>
    </div>
  </div>

  <div class="section">
    <h2><span class="icon">🧑‍💻</span>5. getUseragent 测试</h2>
    <button onclick="callGetUseragent()">🔍 获取 useragent</button>
    <div id="result-getUseragent" class="result-box"></div>
    <button onclick="copyResult('result-getUseragent')"
      style="margin-top:4px;background:#e6f7ff;color:#1890ff;">复制结果</button>
  </div>

  <div class="section">
    <h2><span class="icon">🔑</span>6. googleLogin 测试</h2>
    <button onclick="callGoogleLogin()">🔑 调用 googleLogin</button>
    <div id="result-googleLogin" class="result-box"></div>
    <button onclick="copyResult('result-googleLogin')"
      style="margin-top:4px;background:#e6f7ff;color:#1890ff;">复制结果</button>
  </div>

  <div class="section">
    <h2><span class="icon">🔵</span>7. facebookLogin 测试</h2>
    <button onclick="callFacebookLogin()">🔵 调用 facebookLogin</button>
    <div id="result-facebookLogin" class="result-box"></div>
    <button onclick="copyResult('result-facebookLogin')"
      style="margin-top:4px;background:#e6f7ff;color:#1890ff;">复制结果</button>
  </div>

  <div class="section">
    <h2><span class="icon">📬</span>8. getFcmToken 测试</h2>
    <button onclick="callGetFcmToken()">📬 调用 getFcmToken</button>
    <div id="result-getFcmToken" class="result-box"></div>
    <button onclick="copyResult('result-getFcmToken')"
      style="margin-top:4px;background:#e6f7ff;color:#1890ff;">复制结果</button>
  </div>

  <div class="section">
    <h2><span class="icon">⚠️</span>9. alert 测试</h2>
    <label>message:</label>
    <input id="alertMsg" value="Hello from H5!" />
    <button onclick="callAlert()">⚠️ 调用 alert</button>
    <div id="result-alert" class="result-box"></div>
    <button onclick="copyResult('result-alert')" style="margin-top:4px;background:#e6f7ff;color:#1890ff;">复制结果</button>
  </div>

  <div class="section">
    <h2><span class="icon">🌐</span>10. openWindow 测试</h2>
    <label>url:</label>
    <input id="openWindowUrl" value="https://www.baidu.com" />
    <button onclick="callOpenWindow()">🌐 调用 openWindow</button>
    <div id="result-openWindow" class="result-box"></div>
    <button onclick="copyResult('result-openWindow')"
      style="margin-top:4px;background:#e6f7ff;color:#1890ff;">复制结果</button>
  </div>

  <div class="section">
    <h2><span class="icon">🔗</span>11. handleHtmlLink 测试</h2>
    <label>url:</label>
    <input id="handleHtmlLinkUrl" value="https://www.baidu.com" />
    <button onclick="callHandleHtmlLink()">🔗 调用 handleHtmlLink</button>
    <div id="result-handleHtmlLink" class="result-box"></div>
    <button onclick="copyResult('result-handleHtmlLink')"
      style="margin-top:4px;background:#e6f7ff;color:#1890ff;">复制结果</button>

    <hr style="margin:24px 0;">
    <div style="font-size:1em;color:#2575fc;margin-bottom:8px;">【高级场景模拟】a标签点击拦截 + handleHtmlLink</div>
    <label>模拟业务场景：</label>
    <select id="handleHtmlLinkScene">
      <option value="white">白名单自动跳转</option>
      <option value="black">黑名单拦截弹窗</option>
      <option value="login">需登录弹窗</option>
      <option value="app">App端已处理（H5不跳转）</option>
      <option value="h5">App端未处理（H5自行跳转）</option>
      <option value="other">其他/默认场景（H5自行跳转）</option>
    </select>
    <input id="handleHtmlLinkAUrl" value="https://www.example.com" style="margin-top:8px;" />
    <a id="handleHtmlLinkATag" href="https://www.example.com"
      style="display:inline-block;margin:8px 0 0 0;color:#2575fc;text-decoration:underline;">点击模拟 a 标签</a>
    <div id="result-handleHtmlLinkA" class="result-box"></div>
    <div style="color:#888;font-size:0.95em;margin-top:8px;">说明：点击上方 a 标签会拦截并调用 handleHtmlLink，App端可根据
      url/场景返回不同结果，H5根据返回值决定是否跳转/弹窗。</div>
  </div>


  <!-- ========== 原生JS能力桥接测试 ========== -->
  <div class="section">
    <h2><span class="icon">🧩</span>12. 原生JS能力桥接测试</h2>
    <label>window.alert 测试</label>
    <input id="jsAlertMsg" value="Hello from window.alert!" />
    <button onclick="testJsAlert()">🟣 调用 window.alert</button>
    <div id="result-jsAlert" class="result-box"></div>

    <label style="margin-top:16px;">window.confirm 测试</label>
    <input id="jsConfirmMsg" value="Are you sure?" />
    <button onclick="testJsConfirm()">🟢 调用 window.confirm</button>
    <div id="result-jsConfirm" class="result-box"></div>

    <label style="margin-top:16px;">window.prompt 测试</label>
    <input id="jsPromptMsg" value="请输入内容" />
    <input id="jsPromptDefault" value="默认值" />
    <button onclick="testJsPrompt()">🟠 调用 window.prompt</button>
    <div id="result-jsPrompt" class="result-box"></div>

    <label style="margin-top:16px;">window.open 测试</label>
    <input id="jsOpenUrl" value="https://flutter.dev" />
    <button onclick="testJsOpen()">🔵 调用 window.open</button>
    <div id="result-jsOpen" class="result-box"></div>

    <label style="margin-top:16px;">a标签超链接测试</label>
    <input id="jsALink" value="https://www.baidu.com" />
    <a id="testALink" href="https://www.baidu.com" target="_blank"
      style="display:inline-block;margin-top:8px;color:#2575fc;text-decoration:underline;">点击跳转 a 标签</a>
    <div id="result-jsALink" class="result-box"></div>
  </div>

  <script>
    console.log('H5 JS loaded at', new Date());

    // 环境检测
    function checkBridgeEnv() {
      var envStatus = document.getElementById('envStatus');
      if (window.flutter_inappwebview && typeof window.flutter_inappwebview.callHandler === 'function') {
        envStatus.textContent = '✅ 已检测到桥接环境，可正常调用';
        envStatus.className = 'env-status env-ok';
        return true;
      } else {
        envStatus.textContent = '❌ 未检测到桥接环境，请在App内WebView中打开';
        envStatus.className = 'env-status env-fail';
        return false;
      }
    }
    checkBridgeEnv();

    // eventTracker 测试
    function callEventTracker() {
      if (!checkBridgeEnv()) {
        showResult('result-eventTracker', 'eventTracker', {}, '[未检测到桥接环境]');
        return;
      }
      let eventName = document.getElementById('eventTrackerName').value;
      let eventValue = safeParse(document.getElementById('eventTrackerValue').value);
      if (!eventName || !eventValue) return;
      window.flutter_inappwebview.callHandler('eventTracker', { eventName, eventValue })
        .then(function (result) {
          showResult('result-eventTracker', 'eventTracker', { eventName, eventValue }, result);
        })
        .catch(function (err) {
          showResult('result-eventTracker', 'eventTracker', { eventName, eventValue }, '[异常] ' + err);
        });
    }

    // openWebView 测试
    function callOpenWebView(type, url) {
      const params = { type, url };
      if (window.flutter_inappwebview && window.flutter_inappwebview.callHandler) {
        window.flutter_inappwebview.callHandler('openWebView', params).then(function (result) {
          console.log('openWebView result:', result);
          showResult('resultBox', 'openWebView', params, result);
          if (!result) {
            alert('插件返回结果为 null，请检查插件端 openWebView handler 的返回值！');
            return;
          }
          if (result.code === 0 && result.data && result.data.type && result.data.url) {
            if (result.data.type === 2) {
              window.location.href = result.data.url;
            } else if (result.data.type === 1) {
              window.open(result.data.url, '_blank');
            }
          }
        });
      } else {
        showResult('resultBox', 'openWebView', params, { code: -1, msg: '未检测到 flutter_inappwebview 环境', data: null });
      }
    }

    // openAndroid 测试
    function callOpenAndroid() {
      if (!checkBridgeEnv()) {
        showResult('result-openAndroid', 'openAndroid', {}, '[未检测到桥接环境]');
        return;
      }
      let url = document.getElementById('openAndroidUrl').value;
      window.flutter_inappwebview.callHandler('openAndroid', { url })
        .then(function (result) {
          showResult('result-openAndroid', 'openAndroid', { url }, result);
        })
        .catch(function (err) {
          showResult('result-openAndroid', 'openAndroid', { url }, '[异常] ' + err);
        });
    }

    // closeWebView 测试
    function callCloseWebView() {
      if (!checkBridgeEnv()) {
        showResult('result-closeWebView', 'closeWebView', {}, '[未检测到桥接环境]');
        return;
      }
      window.flutter_inappwebview.callHandler('closeWebView', {})
        .then(function (result) {
          showResult('result-closeWebView', 'closeWebView', {}, result);
          // 仅在二级页面自动关闭
          if (isChildPage() && result && result.code === 0 && result.data && result.data.closed === true) {
            window.close();
            // 兜底：关闭失败时返回上一页
            setTimeout(function () {
              if (!window.closed) {
                window.history.back();
              }
            }, 300);
          }
        })
        .catch(function (err) {
          showResult('result-closeWebView', 'closeWebView', {}, '[异常] ' + err);
        });
    }

    // getUseragent 测试
    function callGetUseragent() {
      if (!checkBridgeEnv()) {
        showResult('result-getUseragent', 'getUseragent', {}, '[未检测到桥接环境]');
        return;
      }
      window.flutter_inappwebview.callHandler('getUseragent', {})
        .then(function (result) {
          showResult('result-getUseragent', 'getUseragent', {}, result);
        })
        .catch(function (err) {
          showResult('result-getUseragent', 'getUseragent', {}, '[异常] ' + err);
        });
    }

    // googleLogin 测试
    function callGoogleLogin() {
      if (!checkBridgeEnv()) {
        showResult('result-googleLogin', 'googleLogin', {}, '[未检测到桥接环境]');
        return;
      }
      window.flutter_inappwebview.callHandler('googleLogin', {})
        .then(function (result) {
          showResult('result-googleLogin', 'googleLogin', {}, result);
        })
        .catch(function (err) {
          showResult('result-googleLogin', 'googleLogin', {}, '[异常] ' + err);
        });
    }

    // facebookLogin 测试
    function callFacebookLogin() {
      if (!checkBridgeEnv()) {
        showResult('result-facebookLogin', 'facebookLogin', {}, '[未检测到桥接环境]');
        return;
      }
      window.flutter_inappwebview.callHandler('facebookLogin', {})
        .then(function (result) {
          showResult('result-facebookLogin', 'facebookLogin', {}, result);
        })
        .catch(function (err) {
          showResult('result-facebookLogin', 'facebookLogin', {}, '[异常] ' + err);
        });
    }

    // getFcmToken 测试
    function callGetFcmToken() {
      if (!checkBridgeEnv()) {
        showResult('result-getFcmToken', 'getFcmToken', {}, '[未检测到桥接环境]');
        return;
      }
      window.flutter_inappwebview.callHandler('getFcmToken', {})
        .then(function (result) {
          showResult('result-getFcmToken', 'getFcmToken', {}, result);
        })
        .catch(function (err) {
          showResult('result-getFcmToken', 'getFcmToken', {}, '[异常] ' + err);
        });
    }

    // alert 测试
    function callAlert() {
      if (!checkBridgeEnv()) {
        showResult('result-alert', 'alert', {}, '[未检测到桥接环境]');
        return;
      }
      let message = document.getElementById('alertMsg').value;
      window.flutter_inappwebview.callHandler('alert', { message })
        .then(function (result) {
          showResult('result-alert', 'alert', { message }, result);
        })
        .catch(function (err) {
          showResult('result-alert', 'alert', { message }, '[异常] ' + err);
        });
    }

    // openWindow 测试
    function callOpenWindow() {
      if (!checkBridgeEnv()) {
        showResult('result-openWindow', 'openWindow', {}, '[未检测到桥接环境]');
        return;
      }
      let url = document.getElementById('openWindowUrl').value;
      window.flutter_inappwebview.callHandler('openWindow', { url })
        .then(function (result) {
          showResult('result-openWindow', 'openWindow', { url }, result);
        })
        .catch(function (err) {
          showResult('result-openWindow', 'openWindow', { url }, '[异常] ' + err);
        });
    }

    // handleHtmlLink 测试
    function callHandleHtmlLink() {
      if (!checkBridgeEnv()) {
        showResult('result-handleHtmlLink', 'handleHtmlLink', {}, '[未检测到桥接环境]');
        return;
      }
      let url = document.getElementById('handleHtmlLinkUrl').value;
      window.flutter_inappwebview.callHandler('handleHtmlLink', { url })
        .then(function (result) {
          showResult('result-handleHtmlLink', 'handleHtmlLink', { url }, result);
        })
        .catch(function (err) {
          showResult('result-handleHtmlLink', 'handleHtmlLink', { url }, '[异常] ' + err);
        });
    }

    function showResult(boxId, method, params, result) {
      let box = document.getElementById(boxId);
      let msg = `[${new Date().toLocaleTimeString()}] 方法: ${method}\n参数: ${JSON.stringify(params)}\n原始结果: ${JSON.stringify(result)}`;
      box.innerHTML = `<span style='color:#2575fc;'>${msg.replace(/\n/g, '<br>')}</span>`;
    }

    // JSON安全解析
    function safeParse(str) {
      try {
        return JSON.parse(str);
      } catch (e) {
        alert('参数不是合法JSON');
        return null;
      }
    }

    function copyResult(boxId) {
      var box = document.getElementById(boxId);
      var text = box.innerText || box.textContent;
      if (!text) return;
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(function () {
          alert('结果已复制到剪贴板');
        });
      } else {
        // 兼容旧浏览器
        var textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        alert('结果已复制到剪贴板');
      }
    }

    // 显示当前时间戳，便于判断页面是否被缓存
    document.getElementById('timestampValue').textContent = Date.now();

    // 打开二级测试页
    let isOpeningChildPage = false; // 防重复点击
    function openChildTestPage() {
      if (isOpeningChildPage) {
        console.log('正在打开二级测试页，请勿重复点击');
        return;
      }

      isOpeningChildPage = true;
      const childUrl = window.location.href.split('?')[0] + '?scene=child';

      // 优先使用 openWebView 内嵌跳转（type=2）
      if (window.flutter_inappwebview && window.flutter_inappwebview.callHandler) {
        console.log('使用桥接方式打开二级测试页:', childUrl);
        window.flutter_inappwebview.callHandler('openWebView', {
          type: 2,
          url: childUrl
        }).then(function (result) {
          console.log('打开二级测试页 openWebView result:', result);
          // 检查桥接调用是否成功
          if (result && result.code === 0 && result.data && result.data.opened) {
            console.log('桥接跳转成功，页面将在当前WebView中加载');
            // 成功时不需要额外操作，WebView会自动加载新页面
          } else {
            // 如果桥接失败，回退到 window.open
            console.warn('桥接跳转失败，回退到 window.open。result:', result);
            window.open(childUrl, '_blank');
          }
          // 延迟重置防重复标志
          setTimeout(() => { isOpeningChildPage = false; }, 1000);
        }).catch(function (err) {
          console.error('桥接跳转异常，回退到 window.open:', err);
          window.open(childUrl, '_blank');
          setTimeout(() => { isOpeningChildPage = false; }, 1000);
        });
      } else {
        // 未检测到桥接环境，直接使用 window.open
        console.log('未检测到桥接环境，使用 window.open');
        window.open(childUrl, '_blank');
        setTimeout(() => { isOpeningChildPage = false; }, 1000);
      }
    }

    // 判断是否为二级测试页
    function isChildPage() {
      return /[?&]scene=child/.test(window.location.search);
    }

    function testJsAlert() {
      let msg = document.getElementById('jsAlertMsg').value;
      let t0 = Date.now();
      alert(msg);
      let t1 = Date.now();
      document.getElementById('result-jsAlert').innerHTML =
        `<span style='color:#2575fc;'>alert弹窗已调用，耗时${t1 - t0}ms</span>`;
    }

    function testJsConfirm() {
      let msg = document.getElementById('jsConfirmMsg').value;
      let t0 = Date.now();
      let result = confirm(msg);
      let t1 = Date.now();
      document.getElementById('result-jsConfirm').innerHTML =
        `<span style='color:#2575fc;'>confirm弹窗结果: <b>${result}</b>，耗时${t1 - t0}ms</span>`;
    }

    function testJsPrompt() {
      let msg = document.getElementById('jsPromptMsg').value;
      let def = document.getElementById('jsPromptDefault').value;
      let t0 = Date.now();
      let result = prompt(msg, def);
      let t1 = Date.now();
      document.getElementById('result-jsPrompt').innerHTML =
        `<span style='color:#2575fc;'>prompt弹窗结果: <b>${result}</b>，耗时${t1 - t0}ms</span>`;
    }

    function testJsOpen() {
      let url = document.getElementById('jsOpenUrl').value;
      let t0 = Date.now();
      window.open(url, '_blank');
      let t1 = Date.now();
      document.getElementById('result-jsOpen').innerHTML =
        `<span style='color:#2575fc;'>window.open已调用，耗时${t1 - t0}ms</span>`;
    }

    // 动态绑定a标签href
    document.getElementById('jsALink').addEventListener('input', function () {
      document.getElementById('testALink').href = this.value;
    });
    document.getElementById('testALink').addEventListener('click', function () {
      document.getElementById('result-jsALink').innerHTML =
        `<span style='color:#2575fc;'>a标签已点击，目标: ${this.href}</span>`;
    });

    // handleHtmlLink 场景模拟 - 确保在DOM加载完成后绑定事件
    function initializeHandleHtmlLinkEvents() {
      console.log('🔧 初始化 handleHtmlLink 事件绑定...');

      // URL输入框同步到a标签href
      var urlInput = document.getElementById('handleHtmlLinkAUrl');
      var aTag = document.getElementById('handleHtmlLinkATag');

      if (urlInput && aTag) {
        // 防止重复绑定：先移除可能存在的事件监听器
        urlInput.removeEventListener('input', urlInputHandler);
        aTag.removeEventListener('click', aTagClickHandler);

        // 重新绑定事件
        urlInput.addEventListener('input', urlInputHandler);
        aTag.addEventListener('click', aTagClickHandler);

        console.log('✅ handleHtmlLink 事件绑定完成');
      } else {
        console.error('❌ 找不到必要的DOM元素:', { urlInput, aTag });
      }
    }

    // URL输入处理函数
    function urlInputHandler() {
      var aTag = document.getElementById('handleHtmlLinkATag');
      if (aTag) {
        aTag.href = this.value;
        console.log('🔗 URL已更新:', this.value);
      }
    }

    // a标签点击处理函数
    function aTagClickHandler(e) {
      console.log('🖱️ a标签被点击，开始拦截处理...');
      e.preventDefault(); // 阻止默认跳转
      e.stopPropagation(); // 阻止事件冒泡

      var url = this.href;
      var scene = document.getElementById('handleHtmlLinkScene').value;

      console.log('📋 当前场景:', scene);
      console.log('🌐 目标URL:', url);

      if (window.flutter_inappwebview && window.flutter_inappwebview.callHandler) {
        console.log('🚀 调用 handleHtmlLink JSBridge...');
        window.flutter_inappwebview.callHandler('handleHtmlLink', { url, scene })
          .then(function (result) {
            console.log('✅ handleHtmlLink 调用成功:');
            console.log('- 场景:', scene);
            console.log('- URL:', url);
            console.log('- 原始返回结果:', result);
            console.log('- result.data:', result?.data);
            console.log('- result.data.handled:', result?.data?.handled);
            console.log('- result.data.handled类型:', typeof (result?.data?.handled));

            let msg = `[${new Date().toLocaleTimeString()}] handleHtmlLink 场景: ${scene}\nurl: ${url}\nApp端返回: ${JSON.stringify(result)}\n`;

            // 详细的调试信息
            let debugInfo = '';
            if (result && result.data) {
              debugInfo += `\n🔍 调试信息:\n`;
              debugInfo += `- result.data.handled 值: ${result.data.handled}\n`;
              debugInfo += `- result.data.handled 类型: ${typeof (result.data.handled)}\n`;
              debugInfo += `- == false: ${result.data.handled == false}\n`;
              debugInfo += `- == 'login': ${result.data.handled == 'login'}\n`;
              debugInfo += `- == 'black': ${result.data.handled == 'black'}\n`;
              debugInfo += `- == true: ${result.data.handled == true}\n`;
            }

            document.getElementById('result-handleHtmlLinkA').innerHTML = `<span style='color:#2575fc;'>${(msg + debugInfo).replace(/\n/g, '<br>')}</span>`;

            // H5根据App端返回决定后续动作（兼容各种类型）
            if (result && result.data) {
              const handledValue = result.data.handled;
              if (handledValue === false || handledValue === 'false' || handledValue === 0 || handledValue === '0') {
                // H5自行跳转，直接跳转无需弹窗
                console.log('🔄 执行 H5 自行跳转（无弹窗）');
                window.location.href = url;
              } else if (handledValue === 'login') {
                // 只弹窗，不跳转
                console.log('🔐 显示登录提示');
                if (window.flutter_inappwebview && window.flutter_inappwebview.callHandler) {
                  window.flutter_inappwebview.callHandler('alert', { message: '请先登录后再访问该链接！' });
                } else {
                  alert('请先登录后再访问该链接！');
                }
                // 不跳转
              } else if (handledValue === 'black') {
                // 只弹窗，不跳转
                console.log('🚫 显示拦截提示');
                if (window.flutter_inappwebview && window.flutter_inappwebview.callHandler) {
                  window.flutter_inappwebview.callHandler('alert', { message: '该链接已被拦截，禁止访问！' });
                } else {
                  alert('该链接已被拦截，禁止访问！');
                }
                // 不跳转
              } else if (handledValue === true || handledValue === 'true' || handledValue === 1 || handledValue === '1') {
                // 只弹窗，不跳转
                console.log('✅ App端已处理');
                if (window.flutter_inappwebview && window.flutter_inappwebview.callHandler) {
                  window.flutter_inappwebview.callHandler('alert', { message: `场景 "${scene}" - App端已处理，H5无需操作` });
                } else {
                  alert(`场景 "${scene}" - App端已处理，H5无需操作`);
                }
                // 不跳转
              } else {
                // 只弹窗，不跳转
                console.log('❓ 未知的 handled 值:', handledValue);
                if (window.flutter_inappwebview && window.flutter_inappwebview.callHandler) {
                  window.flutter_inappwebview.callHandler('alert', { message: `未知的 handled 值: ${handledValue}，类型: ${typeof (handledValue)}` });
                } else {
                  alert(`未知的 handled 值: ${handledValue}，类型: ${typeof (handledValue)}`);
                }
                // 不跳转
              }
            } else {
              console.log('❌ 返回结果结构异常');
              alert('返回结果结构异常，无法处理');
            }
          })
          .catch(function (error) {
            console.error('❌ handleHtmlLink 调用失败:', error);
            document.getElementById('result-handleHtmlLinkA').innerHTML = `<span style='color:red;'>调用失败: ${error}</span>`;
          });
      } else {
        console.warn('❌ 未检测到桥接环境');
        alert('未检测到桥接环境，无法调用 handleHtmlLink');
      }
    }

    // 立即执行事件绑定（确保DOM已加载）
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function () {
        initializeHandleHtmlLinkEvents();
        autoStartDiagnostics(); // 自动启动诊断
      });
    } else {
      initializeHandleHtmlLinkEvents();
      autoStartDiagnostics(); // 自动启动诊断
    }

    // 官方事件标准参数
    const eventParams = {
      firstOpen: {},
      registerSubmit: { method: 'username' },
      register: {
        method: 'username',
        customerId: 12345,
        customerName: '张三',
        mobileNum: '13800138000'
      },
      depositSubmit: {
        customerName: '张三',
        customerId: 12345,
        revenue: '100',
        value: '100',
        af_revenue: 100
      },
      firstDeposit: {
        customerName: '张三',
        customerId: 12345,
        revenue: '100',
        value: '100',
        af_revenue: 100
      },
      withdraw: {
        customerName: '张三',
        customerId: 12345,
        amount: '-50',
        value: '-50',
        af_revenue: -50
      },
      firstDepositArrival: {
        customerName: '张三',
        customerId: 12345,
        revenue: '100',
        value: '100',
        af_revenue: 100
      },
      deposit: {
        customerName: '张三',
        customerId: 12345,
        revenue: '100',
        value: '100',
        af_revenue: 100
      }
    };

    // 12个事件名（如需扩展可在此补充）
    const officialEvents = [
      'firstOpen',
      'registerSubmit',
      'register',
      'depositSubmit',
      'firstDeposit',
      'withdraw',
      'firstDepositArrival',
      'deposit',
      'openWebView',
      'openAndroid',
      'closeWebView',
      'getUseragent'
    ];
    const container = document.getElementById('eventTrackerOfficialTests');
    officialEvents.forEach(eventName => {
      const paramStr = JSON.stringify(eventParams[eventName] || {}, null, 2);
      const html = `
        <div class="accordion" id="accordion-${eventName}">
          <div class="accordion-header" onclick="toggleAccordion('${eventName}')">
            <span>${eventName}</span>
            <span class="accordion-arrow" id="arrow-${eventName}">▶</span>
          </div>
          <div class="accordion-content">
            <div style="margin-top:6px;">
              <label style="font-weight:500;">eventValue (JSON):</label>
              <textarea id="officialEventValue_${eventName}" style="width:100%;min-height:48px;">${paramStr}</textarea>
            </div>
            <div style="margin-top:6px;display:flex;gap:8px;">
              <button onclick="resetOfficialEventValue('${eventName}')" style="background:#e6f7ff;color:#1890ff;">重置为标准参数</button>
              <button onclick="testOfficialEventEditable('${eventName}')">测试</button>
            </div>
            <div id="result-officialEvent-${eventName}" class="result-box" style="margin-top:6px;"></div>
          </div>
        </div>
      `;
      container.insertAdjacentHTML('beforeend', html);
    });

    function toggleAccordion(eventName) {
      const acc = document.getElementById('accordion-' + eventName);
      const arrow = document.getElementById('arrow-' + eventName);
      if (acc.classList.contains('open')) {
        acc.classList.remove('open');
        arrow.classList.remove('open');
      } else {
        acc.classList.add('open');
        arrow.classList.add('open');
      }
    }
    function resetOfficialEventValue(eventName) {
      document.getElementById('officialEventValue_' + eventName).value = JSON.stringify(eventParams[eventName] || {}, null, 2);
    }
    function testOfficialEventEditable(eventName) {
      if (!checkBridgeEnv()) {
        showResult('result-officialEvent-' + eventName, 'eventTracker', {}, '[未检测到桥接环境]');
        return;
      }
      let eventValueStr = document.getElementById('officialEventValue_' + eventName).value;
      let eventValue = safeParse(eventValueStr);
      if (eventValue === null) return;
      window.flutter_inappwebview.callHandler('eventTracker', { eventName, eventValue })
        .then(function (result) {
          showResult('result-officialEvent-' + eventName, 'eventTracker', { eventName, eventValue }, result);
        })
        .catch(function (err) {
          showResult('result-officialEvent-' + eventName, 'eventTracker', { eventName, eventValue }, '[异常] ' + err);
        });
    }

    // 渲染所有一级功能区为折叠面板
    document.addEventListener('DOMContentLoaded', function () {
      console.log('🔄 开始转换为折叠面板...');

      const sectionTitles = [
        '1. eventTracker 测试',
        '2. openWebView 测试',
        '3. openAndroid 测试',
        '4. closeWebView 测试',
        '5. getUseragent 测试',
        '6. googleLogin 测试',
        '7. facebookLogin 测试',
        '8. getFcmToken 测试',
        '9. alert 测试',
        '10. openWindow 测试',
        '11. handleHtmlLink 测试',
        '12. 原生JS能力桥接测试'
      ];
      const allSections = Array.from(document.querySelectorAll('.section'));
      allSections.forEach((section, idx) => {
        const title = sectionTitles[idx] || `功能区${idx + 1}`;
        const content = section.innerHTML;
        const html = `
          <div class="accordion-main" id="main-accordion-${idx}">
            <div class="accordion-main-header" onclick="toggleMainAccordion(${idx})">
              <span>${title}</span>
              <span class="accordion-main-arrow" id="main-arrow-${idx}">▶</span>
            </div>
            <div class="accordion-main-content">
              ${content}
            </div>
          </div>
        `;
        section.outerHTML = html;
      });

      console.log('✅ 折叠面板转换完成');

      // 关键修复：DOM重建后重新绑定 handleHtmlLink 事件
      console.log('🔧 DOM重建后重新绑定 handleHtmlLink 事件...');

      // 延迟一下确保DOM更新完成
      setTimeout(function () {
        initializeHandleHtmlLinkEvents();
        console.log('🔄 handleHtmlLink 事件重新绑定完成');
      }, 100);
    });
    function toggleMainAccordion(idx) {
      const acc = document.getElementById('main-accordion-' + idx);
      const arrow = document.getElementById('main-arrow-' + idx);
      if (acc.classList.contains('open')) {
        acc.classList.remove('open');
        arrow.classList.remove('open');
      } else {
        acc.classList.add('open');
        arrow.classList.add('open');
      }
    }

    // firstOpen 沙盒测试
    function testFirstOpenSandbox() {
      if (!checkBridgeEnv()) {
        showResult('result-firstOpen-sandbox', 'eventTracker', {}, '[未检测到桥接环境]');
        return;
      }

      console.log('🚀 开始测试 firstOpen 事件 (沙盒环境)');
      console.log('📋 配置信息: Event Token = q6mgkw, 环境 = SANDBOX');

      // 增强的调试信息显示
      const resultBox = document.getElementById('result-firstOpen-sandbox');
      resultBox.innerHTML = `
        <div style="color:#1890ff;font-weight:bold;">⏳ 正在发送 firstOpen 事件...</div>
        <div style="color:#666;font-size:0.9em;margin-top:4px;">
          📋 App Token: y0mht8z9n1fk<br>
          🎯 Event Token: q6mgkw<br>
          🌍 环境: SANDBOX (沙盒)<br>
          ⏰ 发送时间: ${new Date().toLocaleString()}
        </div>
      `;

      window.flutter_inappwebview.callHandler('eventTracker', {
        eventName: 'firstOpen',
        eventValue: {}
      }).then(function (result) {
        console.log('✅ eventTracker 桥接调用成功，返回结果:', result);

        // 详细的结果显示
        let resultHtml = `
          <div style="color:#52c41a;font-weight:bold;">✅ 桥接调用成功</div>
          <div style="color:#666;font-size:0.9em;margin:8px 0;">
            📤 发送时间: ${new Date().toLocaleString()}<br>
            📋 事件名称: firstOpen<br>
            🎯 Event Token: q6mgkw<br>
            📊 本地处理结果: ${JSON.stringify(result)}
          </div>
        `;

        if (result && result.code === 0) {
          resultHtml += `
            <div style="background:#e6ffed;border:1px solid #b7eb8f;border-radius:6px;padding:10px;margin:8px 0;">
              <div style="color:#237804;font-weight:bold;">🎉 本地处理成功！</div>
              <div style="color:#52c41a;font-size:0.9em;margin-top:4px;">
                ✅ 事件已发送到 Adjust SDK<br>
                ⏳ 正在等待服务器回调...
              </div>
            </div>
            <div style="background:#fff8e6;border:1px solid #ffe066;border-radius:6px;padding:10px;margin:8px 0;">
              <div style="color:#b8860b;font-weight:bold;">📊 数据查看指南：</div>
              <div style="color:#b8860b;font-size:0.9em;margin-top:4px;">
                1. <strong>沙盒环境数据不会显示在主控制台</strong><br>
                2. 请在 Adjust 后台查看: <strong>【测试】→ 【设备日志】</strong><br>
                3. 等待 2-5 分钟查看服务器回调<br>
                4. 如果控制台显示 "🎉 [Adjust] 事件上报成功！" 说明服务器已收到
              </div>
            </div>
            <div style="background:#f0f7ff;border:1px solid #b3c6e6;border-radius:6px;padding:10px;margin:8px 0;">
              <div style="color:#1890ff;font-weight:bold;">🔍 调试提示：</div>
              <div style="color:#1890ff;font-size:0.9em;margin-top:4px;">
                • 如果 5 分钟内无服务器回调，可能存在网络问题<br>
                • 沙盒环境延迟可能较高，请耐心等待<br>
                • 可以在 App 的调试工具中查看更详细信息
              </div>
            </div>
          `;

          console.log('🎉 firstOpen 事件处理成功！请查看控制台是否有 Adjust 回调日志');
        } else {
          resultHtml += `
            <div style="background:#fff1f0;border:1px solid #ffa39e;border-radius:6px;padding:10px;margin:8px 0;">
              <div style="color:#cf1322;font-weight:bold;">❌ 本地处理失败</div>
              <div style="color:#cf1322;font-size:0.9em;margin-top:4px;">
                请检查事件配置和网络连接
              </div>
            </div>
          `;
          console.error('❌ firstOpen 事件处理失败:', result);
        }

        resultBox.innerHTML = resultHtml;
      }).catch(function (err) {
        console.error('❌ eventTracker 桥接调用异常:', err);

        const errorHtml = `
          <div style="color:#cf1322;font-weight:bold;">❌ 桥接调用失败</div>
          <div style="color:#cf1322;font-size:0.9em;margin:8px 0;">
            错误信息: ${err}<br>
            请检查桥接环境和网络连接
          </div>
        `;

        document.getElementById('result-firstOpen-sandbox').innerHTML = errorHtml;
      });
    }

    // 添加 Adjust 回调状态监听
    function startAdjustCallbackMonitoring() {
      console.log('🔍 开始监听 Adjust 服务器回调...');

      // 创建一个全局变量来跟踪回调
      window.adjustCallbackReceived = false;
      window.adjustCallbackDetails = null;

      // 定时检查回调状态
      const checkInterval = setInterval(() => {
        if (window.adjustCallbackReceived) {
          console.log('✅ 检测到 Adjust 服务器回调！', window.adjustCallbackDetails);
          clearInterval(checkInterval);

          // 更新页面显示
          const resultBox = document.getElementById('result-firstOpen-sandbox');
          if (resultBox) {
            const callbackHtml = `
              <div style="background:#e6ffed;border:2px solid #52c41a;border-radius:6px;padding:12px;margin:8px 0;">
                <div style="color:#237804;font-weight:bold;">🎉 收到 Adjust 服务器回调！</div>
                <div style="color:#52c41a;font-size:0.9em;margin-top:4px;">
                  ⏰ 回调时间: ${new Date().toLocaleString()}<br>
                  📊 回调详情: ${JSON.stringify(window.adjustCallbackDetails)}
                </div>
              </div>
            `;
            resultBox.innerHTML += callbackHtml;
          }
        }
      }, 1000);

      // 10 分钟后停止监听
      setTimeout(() => {
        if (!window.adjustCallbackReceived) {
          console.log('⚠️ 10 分钟内未收到 Adjust 服务器回调');
          clearInterval(checkInterval);
        }
      }, 600000);
    }

    // 添加网络状态检查
    function checkNetworkAndAdjustStatus() {
      console.log('🌐 检查网络状态和 Adjust 连接...');

      const statusHtml = `
        <div style="background:#f0f7ff;border:1px solid #b3c6e6;border-radius:6px;padding:10px;margin:8px 0;">
          <div style="color:#1890ff;font-weight:bold;">🔍 环境检查结果：</div>
          <div style="color:#1890ff;font-size:0.9em;margin-top:4px;">
            • 网络状态: ${navigator.onLine ? '✅ 在线' : '❌ 离线'}<br>
            • User Agent: ${navigator.userAgent.substring(0, 100)}...<br>
            • 当前时间: ${new Date().toLocaleString()}<br>
            • 页面 URL: ${window.location.href}
          </div>
        </div>
      `;

      const resultBox = document.getElementById('result-firstOpen-sandbox');
      if (resultBox) {
        resultBox.innerHTML += statusHtml;
      }
    }

    // 清除沙盒测试结果
    function clearSandboxResult() {
      const resultBox = document.getElementById('result-firstOpen-sandbox');
      if (resultBox) {
        resultBox.innerHTML = '<div style="color:#999;">结果已清除，可以重新测试</div>';
      }
      console.log('🧹 已清除沙盒测试结果');
    }

    // 打开 App 内调试工具
    function openAdjustDebugTool() {
      if (!checkBridgeEnv()) {
        alert('未检测到桥接环境，无法打开调试工具');
        return;
      }

      console.log('🛠️ 尝试打开 Adjust 调试工具...');

      // 尝试通过桥接打开调试页面
      if (window.flutter_inappwebview && window.flutter_inappwebview.callHandler) {
        window.flutter_inappwebview.callHandler('openWebView', {
          type: 2, // 内嵌模式
          url: '/adjust-debug' // 调试工具路径
        }).then(function (result) {
          console.log('调试工具打开结果:', result);
          if (result && result.code === 0) {
            console.log('✅ 调试工具打开成功');
          } else {
            console.warn('⚠️ 调试工具打开失败，请手动在 App 中访问');
            alert('调试工具打开失败，请在 App 中手动访问【我的】→【Adjust 调试工具】');
          }
        }).catch(function (err) {
          console.error('调试工具打开异常:', err);
          alert('请在 App 中手动访问【我的】→【Adjust 调试工具】');
        });
      }
    }

    // 自动启动监控和检查
    function autoStartDiagnostics() {
      console.log('🚀 自动启动诊断和监控...');

      // 页面加载后自动开始监控
      setTimeout(function () {
        startAdjustCallbackMonitoring();
      }, 1000);

      // 显示当前状态
      const envInfo = document.createElement('div');
      envInfo.innerHTML = `
         <div style="background:#f0f7ff;border:1px solid #b3c6e6;border-radius:8px;padding:12px;margin:16px auto;max-width:520px;">
           <div style="color:#1890ff;font-weight:bold;text-align:center;">📊 Adjust 沙盒环境监控已启动</div>
           <div style="color:#666;font-size:0.9em;text-align:center;margin-top:8px;">
             自动监听服务器回调，如有异常会在控制台提示
           </div>
         </div>
       `;

      // 插入到页面标题下方
      const banner = document.querySelector('.banner');
      if (banner && banner.nextSibling) {
        banner.parentNode.insertBefore(envInfo, banner.nextSibling);
      }
    }

    // 增强版 EventTracker 测试函数
    function testEnhancedEventTracker(eventName) {
      if (!checkBridgeEnv()) {
        showResult('result-enhanced-tracker', 'enhancedEventTracker', {}, '[未检测到桥接环境]');
        return;
      }

      console.log('🚀 开始增强版 EventTracker 测试:', eventName);

      // 设置默认的事件参数
      const defaultParams = {
        firstOpen: {},
        register: {
          method: 'username',
          customerId: 12345,
          customerName: '张三',
          mobileNum: '13800138000'
        },
        deposit: {
          customerName: '张三',
          customerId: 12345,
          revenue: '100',
          value: '100',
          af_revenue: 100
        }
      };

      const eventValue = defaultParams[eventName] || {};
      const timestamp = new Date().toISOString();

      // 显示开始测试的状态
      const resultBox = document.getElementById('result-enhanced-tracker');
      resultBox.innerHTML = `
        <div style="color:#ff6b35;font-weight:bold;">🚀 正在调用增强版 EventTracker...</div>
        <div style="color:#666;font-size:0.9em;margin-top:4px;">
          📋 事件名称: ${eventName}<br>
          📊 事件参数: ${JSON.stringify(eventValue)}<br>
          ⏰ 开始时间: ${timestamp}<br>
          🔄 调用方式: 增强版 (直接调用原生 EventTracker 服务)
        </div>
      `;

      // 调用我们在main.dart中定义的增强处理函数
      // 注意：这里我们使用特殊的handler名称来调用增强版
      window.flutter_inappwebview.callHandler('enhancedEventTracker', {
        eventName: eventName,
        eventValue: eventValue
      }).then(function (result) {
        console.log('✅ 增强版 EventTracker 调用成功:', result);

        const endTime = new Date().toISOString();
        let resultHtml = `
          <div style="border:2px solid #ff6b35;border-radius:8px;padding:12px;margin:8px 0;">
            <div style="color:#ff6b35;font-weight:bold;">🎉 增强版 EventTracker 测试完成</div>
            <div style="color:#666;font-size:0.9em;margin-top:8px;">
              📋 事件名称: ${eventName}<br>
              📊 事件参数: ${JSON.stringify(eventValue)}<br>
              ⏰ 开始时间: ${timestamp}<br>
              ⏰ 完成时间: ${endTime}<br>
              🔄 调用方式: 增强版 (原生 EventTracker 服务)
            </div>
          </div>
        `;

        if (result && result.code === 0) {
          resultHtml += `
            <div style="background:#e6ffed;border:1px solid #52c41a;border-radius:6px;padding:10px;margin:8px 0;">
              <div style="color:#237804;font-weight:bold;">✅ 增强版处理成功！</div>
              <div style="color:#52c41a;font-size:0.9em;margin-top:4px;">
                📤 事件已通过增强版 EventTracker 发送<br>
                🎯 包含完整的回调监听和调试信息<br>
                📊 处理结果: ${JSON.stringify(result.data || result)}<br>
                💡 请查看控制台获取详细的 Adjust 回调信息
              </div>
            </div>
            <div style="background:#fff0e6;border:1px solid #ff6b35;border-radius:6px;padding:10px;margin:8px 0;">
              <div style="color:#ff6b35;font-weight:bold;">🔍 增强版特色功能：</div>
              <div style="color:#d45087;font-size:0.9em;margin-top:4px;">
                • 完整的 Adjust 服务器回调信息<br>
                • 实时的设备 ADID 和环境状态<br>
                • 详细的错误诊断和调试信息<br>
                • 这就是原来原生 Home 页面橙色 bug 按钮的功能！<br>
                • 对比默认 JSBridge：可以看到完整的处理流程
              </div>
            </div>
          `;
        } else {
          resultHtml += `
            <div style="background:#fff1f0;border:1px solid #cf1322;border-radius:6px;padding:10px;margin:8px 0;">
              <div style="color:#cf1322;font-weight:bold;">❌ 增强版处理失败</div>
              <div style="color:#cf1322;font-size:0.9em;margin-top:4px;">
                错误信息: ${result?.msg || '未知错误'}<br>
                返回结果: ${JSON.stringify(result)}
              </div>
            </div>
          `;
        }

        resultBox.innerHTML = resultHtml;
      }).catch(function (err) {
        console.error('❌ 增强版 EventTracker 调用失败:', err);

        const errorHtml = `
          <div style="border:2px solid #cf1322;border-radius:8px;padding:12px;margin:8px 0;">
            <div style="color:#cf1322;font-weight:bold;">❌ 增强版 EventTracker 调用异常</div>
            <div style="color:#cf1322;font-size:0.9em;margin-top:8px;">
              错误信息: ${err}<br>
              ⚠️ 可能原因: 增强版处理器未正确注册<br>
              💡 回退方案: 请使用默认的 eventTracker 测试
            </div>
          </div>
        `;

        resultBox.innerHTML = errorHtml;
      });
    }

    // 清除增强版测试结果
    function clearEnhancedResult() {
      const resultBox = document.getElementById('result-enhanced-tracker');
      if (resultBox) {
        resultBox.innerHTML = '<div style="color:#999;">增强版测试结果已清除，可以重新测试</div>';
      }
      console.log('🧹 已清除增强版测试结果');
    }

    // 对比测试：同时调用默认版和增强版
    function compareWithDefault() {
      if (!checkBridgeEnv()) {
        alert('未检测到桥接环境，无法进行对比测试');
        return;
      }

      console.log('🔄 开始对比测试：默认版 vs 增强版');

      const resultBox = document.getElementById('result-enhanced-tracker');
      resultBox.innerHTML = `
        <div style="color:#fa8c16;font-weight:bold;">🔄 正在进行对比测试...</div>
        <div style="color:#666;font-size:0.9em;margin-top:4px;">
          同时调用默认版和增强版 EventTracker，对比结果差异
        </div>
      `;

      const eventName = 'firstOpen';
      const eventValue = {};
      const startTime = Date.now();

      Promise.all([
        // 默认版本
        window.flutter_inappwebview.callHandler('eventTracker', {
          eventName: eventName,
          eventValue: eventValue
        }),
        // 增强版本
        window.flutter_inappwebview.callHandler('enhancedEventTracker', {
          eventName: eventName,
          eventValue: eventValue
        })
      ]).then(function (results) {
        const endTime = Date.now();
        const [defaultResult, enhancedResult] = results;

        const compareHtml = `
          <div style="border:2px solid #fa8c16;border-radius:8px;padding:12px;margin:8px 0;">
            <div style="color:#fa8c16;font-weight:bold;">🔄 对比测试完成 (耗时: ${endTime - startTime}ms)</div>
            <div style="margin-top:12px;">
              <div style="background:#f0f7ff;border:1px solid #1890ff;border-radius:6px;padding:8px;margin-bottom:8px;">
                <div style="color:#1890ff;font-weight:bold;">📊 默认版 eventTracker 结果：</div>
                <div style="color:#666;font-size:0.9em;margin-top:4px;font-family:monospace;">
                  ${JSON.stringify(defaultResult, null, 2)}
                </div>
              </div>
              <div style="background:#fff0e6;border:1px solid #ff6b35;border-radius:6px;padding:8px;">
                <div style="color:#ff6b35;font-weight:bold;">🚀 增强版 enhancedEventTracker 结果：</div>
                <div style="color:#666;font-size:0.9em;margin-top:4px;font-family:monospace;">
                  ${JSON.stringify(enhancedResult, null, 2)}
                </div>
              </div>
            </div>
            <div style="background:#e6ffed;border:1px solid #52c41a;border-radius:6px;padding:8px;margin-top:8px;">
              <div style="color:#237804;font-weight:bold;">📝 对比分析：</div>
              <div style="color:#52c41a;font-size:0.9em;margin-top:4px;">
                • 默认版：${defaultResult ? '成功' : '失败'} - 基础桥接调用<br>
                • 增强版：${enhancedResult ? '成功' : '失败'} - 包含详细回调信息<br>
                • 两个版本都成功说明事件处理正常<br>
                • 增强版会在控制台显示更多调试信息
              </div>
            </div>
          </div>
        `;

        resultBox.innerHTML = compareHtml;
      }).catch(function (err) {
        console.error('❌ 对比测试失败:', err);
        resultBox.innerHTML = `
          <div style="color:#cf1322;font-weight:bold;">❌ 对比测试失败</div>
          <div style="color:#cf1322;font-size:0.9em;margin-top:4px;">
            错误信息: ${err}
          </div>
        `;
      });
    }

    // 增强的事件测试函数（可配置参数）
    function testFirstOpenWithParams(customParams = {}) {
      if (!checkBridgeEnv()) {
        showResult('result-firstOpen-sandbox', 'eventTracker', {}, '[未检测到桥接环境]');
        return;
      }

      const eventValue = { ...customParams };
      const timestamp = new Date().toISOString();

      console.log('🚀 开始测试 firstOpen 事件 (增强版)');
      console.log('📋 事件参数:', eventValue);
      console.log('⏰ 测试时间:', timestamp);

      window.flutter_inappwebview.callHandler('eventTracker', {
        eventName: 'firstOpen',
        eventValue: eventValue
      }).then(function (result) {
        console.log('✅ 增强版 firstOpen 测试完成:', result);

        const resultBox = document.getElementById('result-firstOpen-sandbox');
        const enhancedResult = `
           <div style="border:2px solid #52c41a;border-radius:8px;padding:12px;margin:8px 0;">
             <div style="color:#237804;font-weight:bold;">🔬 增强版测试结果</div>
             <div style="color:#666;font-size:0.9em;margin-top:4px;">
               ⏰ 测试时间: ${timestamp}<br>
               📋 事件参数: ${JSON.stringify(eventValue)}<br>
               📊 返回结果: ${JSON.stringify(result)}<br>
               🎯 Event Token: q6mgkw
             </div>
           </div>
         `;

        if (resultBox) {
          resultBox.innerHTML += enhancedResult;
        }
      }).catch(function (err) {
        console.error('❌ 增强版测试失败:', err);
      });
    }
  </script>
</body>

</html>
